{% extends "base.html" %}

{% block content %}
<div class="container">
    <h3 class="mb-3">Manage Students</h3>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="alert alert-{{ category }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="get" class="mb-3">
            <label for="class_select">Select Class:</label>
        <div class="input-group" style="max-width:420px;">
                <select id="class_select" name="class" class="form-select" onchange="loadStudents(this.value);">
                <option value="">-- choose class --</option>
                {% if classes %}
                    <option value="ALL" {% if selected_class == 'ALL' %}selected{% endif %}>All Students</option>
                    {% for cl in classes %}
                        <option value="{{ cl }}" {% if selected_class == cl %}selected{% endif %}>{{ cl }}</option>
                    {% endfor %}
                {% endif %}
            </select>
                <button class="btn btn-primary" id="class-show-btn" type="button">Show</button>
        </div>
    </form>

    <div class="mb-3">
        <div class="d-flex gap-2 align-items-center">
            <a id="export-csv-link" href="{{ url_for('admin_export_students') }}" class="btn btn-outline-success">Export Students (CSV)</a>
            <a id="export-xlsx-link" href="{{ url_for('admin_export_students_xlsx') }}" class="btn btn-outline-success">Export Students (XLSX)</a>
            <a id="template-csv-link" href="{{ url_for('admin_students_template') }}" class="btn btn-outline-secondary">Download Template (CSV)</a>
            <a id="template-xlsx-link" href="{{ url_for('admin_students_template_xlsx') }}" class="btn btn-outline-secondary">Download Template (XLSX)</a>
            <form id="import-csv-form" method="post" action="{{ url_for('admin_import_students') }}" enctype="multipart/form-data" style="display:inline-block;">
                <input type="hidden" name="class" id="import-csv-class" value="">
                <input type="file" name="file" accept="text/csv" required>
                <button class="btn btn-outline-primary">Import CSV</button>
            </form>
            <form id="import-xlsx-form" method="post" action="{{ url_for('admin_import_students_xlsx') }}" enctype="multipart/form-data" style="display:inline-block;">
                <input type="hidden" name="class" id="import-xlsx-class" value="">
                <input type="file" name="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required>
                <button class="btn btn-outline-primary">Import XLSX</button>
            </form>
        </div>
        <small class="text-muted">CSV/XLSX columns: <code>username</code>, <code>full_name</code>, <code>student_class</code>, <code>temp_password</code>, <code>school</code></small>
    </div>

    <script>
    // AJAX helper to load students for a given class. Exposed so the
    // select's onchange can trigger it directly (fixes cases where the
    // Show button may be blocked in the UI).
    async function loadStudents(cls){
        const url = '/admin/students/json?class=' + encodeURIComponent(cls || '');
        try{
            console.debug('Loading students from', url);
            const resp = await fetch(url, {credentials: 'same-origin'});
            if(!resp.ok){ alert('Failed to load students'); return; }
            const data = await resp.json();
            console.debug('Students response', data);
            const tbody = document.querySelector('table tbody');
            if(!tbody) return;
            tbody.innerHTML = '';
            const list = (data.students || []);
            if(list.length === 0){
                console.info('No students returned for class', cls, data);
                // show a clear message in the table when empty
                const tbody = document.querySelector('table tbody');
                if(tbody){
                    tbody.innerHTML = '<tr><td colspan="8" class="text-muted">No students found for this class.</td></tr>';
                }
            }
            list.forEach(s=>{
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" name="selected_students" value="${s.id}" class="student-checkbox"></td>
                    <td>${s.id}</td>
                    <td>${s.username}</td>
                    <td>${s.full_name}</td>
                    <td>${s.student_class}</td>
                    <td>${s.gender || '—'}</td>
                    <td>${s.temp_password || '—'}</td>
                    <td>${s.created_at ? s.created_at.split('T')[0] : ''}</td>
                                        <td>
                                            <a class="btn btn-sm btn-secondary" href="/admin/student/${s.id}/edit">Edit</a>
                                            <form method="post" action="/admin/student/${s.id}/delete" style="display:inline;" onsubmit="return confirm('Delete this student and all their sessions?');"><button class="btn btn-sm btn-danger">Delete</button></form>
                                            <form method="post" action="/admin/student/${s.id}/reset_password" style="display:inline; margin-left:6px;" onsubmit="return confirm('Generate and set a new temporary password for this student?');"><button class="btn btn-sm btn-warning">Reset Password</button></form>
                                        </td>`;
                tbody.appendChild(tr);
            });
            // reattach checkboxes handlers
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(c=> c.addEventListener('change', ()=>{/*noop - bulk handled elsewhere*/}));
        }catch(err){
            console.error('Error loading students', err);
            alert('Failed to load students');
        }
    }
    // attach to Show button as well
    (function(){
        const btn = document.getElementById('class-show-btn');
        const sel = document.getElementById('class_select');
        if(!btn) return;
        btn.addEventListener('click', ()=> loadStudents(sel ? sel.value : ''));
    })();

    // keep export/import forms and links in sync with selected class
    (function(){
        const sel = document.getElementById('class_select');
        const exportCsv = document.getElementById('export-csv-link');
        const exportXlsx = document.getElementById('export-xlsx-link');
        const tplCsv = document.getElementById('template-csv-link');
        const tplXlsx = document.getElementById('template-xlsx-link');
        const importCsvClass = document.getElementById('import-csv-class');
        const importXlsxClass = document.getElementById('import-xlsx-class');
        function updateClassParam(){
            const v = sel ? sel.value : '';
            const q = v ? '?class=' + encodeURIComponent(v) : '';
            if(exportCsv) exportCsv.href = '{{ url_for("admin_export_students") }}' + q;
            if(exportXlsx) exportXlsx.href = '{{ url_for("admin_export_students_xlsx") }}' + q;
            if(tplCsv) tplCsv.href = '{{ url_for("admin_students_template") }}' + q;
            if(tplXlsx) tplXlsx.href = '{{ url_for("admin_students_template_xlsx") }}' + q;
            if(importCsvClass) importCsvClass.value = v || '';
            if(importXlsxClass) importXlsxClass.value = v || '';
        }
        if(sel){ sel.addEventListener('change', updateClassParam); updateClassParam(); }
    })();
    </script>

    <div id="no-class-alert" class="alert alert-info" {% if selected_class %}style="display:none;"{% endif %}>Please select a class to view students.</div>

    <div class="mb-2">
        <label for="student-search" class="form-label">Quick filter in selected class</label>
        <input id="student-search" class="form-control" placeholder="Type username or full name to filter" />
    </div>
    <table class="table table-striped">
        <thead>
                <tr>
                <th><input type="checkbox" id="select_all_students"></th>
                <th>ID</th>
                <th>Username</th>
                <th>Full Name</th>
                <th>Class</th>
                <th>Gender</th>
                <th>Temp Password</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if students %}
                {% for student in students %}
                <tr>
                    <td><input type="checkbox" name="selected_students" value="{{ student.id }}" class="student-checkbox"></td>
                    <td>{{ student.id }}</td>
                    <td>{{ student.username }}</td>
                    <td>{{ student.full_name or '' }}</td>
                    <td>{{ student.student_class or '—' }}</td>
                    <td>{{ student.temp_password or '—' }}</td>
                    <td>{{ student.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <a href="{{ url_for('admin_edit_student', user_id=student.id) }}" class="btn btn-sm btn-secondary">Edit</a>
                        <form method="post" action="{{ url_for('admin_delete_student', user_id=student.id) }}" style="display:inline;" onsubmit="return confirm('Delete this student and all their sessions?');">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                        <form method="post" action="{{ url_for('admin_reset_student_password', user_id=student.id) }}" style="display:inline; margin-left:6px;" onsubmit="return confirm('Generate and set a new temporary password for this student?');">
                            <button type="submit" class="btn btn-sm btn-warning">Reset Password</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <!-- table starts empty; populated by AJAX when a class is selected -->
            {% endif %}
        </tbody>
    </table>

    <form id="bulk-delete-form" method="post" action="{{ url_for('admin_delete_selected_students') }}" onsubmit="return confirm('Delete selected students and all their sessions?');">
        <input type="hidden" name="user_ids" id="bulk-user-ids">
        <button type="submit" class="btn btn-danger" id="bulk-delete-btn" disabled>Delete Selected</button>
    </form>

    <script>
        const selectAll = document.getElementById('select_all_students');
        const checkboxes = document.querySelectorAll('.student-checkbox');
        const bulkBtn = document.getElementById('bulk-delete-btn');
        const bulkIds = document.getElementById('bulk-user-ids');
        function updateBulkState(){
            const checked = Array.from(checkboxes).filter(c=>c.checked);
            bulkBtn.disabled = checked.length === 0;
            bulkIds.value = checked.map(c=>c.value).join(',');
        }
        if(selectAll){
            selectAll.addEventListener('change', ()=>{
                checkboxes.forEach(c=> c.checked = selectAll.checked);
                updateBulkState();
            });
        }
        checkboxes.forEach(c=> c.addEventListener('change', updateBulkState));
        // Quick client-side filtering
        (function(){
            const search = document.getElementById('student-search');
            if(!search) return;
            search.addEventListener('input', ()=>{
                const q = search.value.trim().toLowerCase();
                const rows = document.querySelectorAll('table tbody tr');
                rows.forEach(r=>{
                    const text = r.innerText.toLowerCase();
                    r.style.display = (!q || text.indexOf(q) !== -1) ? '' : 'none';
                });
            });
        })();
    </script>

    <div class="d-flex justify-content-between">
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
        <a href="{{ url_for('admin_add_student') }}" class="btn btn-primary">Add Student</a>
    </div>
</div>
{% endblock %}
