<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Exam Details - {{ exam.title }}</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<div class="container">
    <h1>Exam: {{ exam.title }}</h1>
    <p><strong>Subject:</strong> {{ exam.subject.name }}</p>
    <p><strong>Class:</strong> {{ exam.subject_class or exam.subject.subject_class or '—' }}</p>
    {% if exam.allowed_classes %}
        <p><strong>Allowed Classes:</strong> {{ exam.allowed_classes }}</p>
    {% endif %}
    <p><strong>Code:</strong> {{ exam.code or '—' }}</p>
    <p><strong>Duration:</strong> {{ exam.duration }} minutes</p>
    <p><strong>Total Marks:</strong> {{ exam.total_marks }}</p>
    <form method="post" action="{{ url_for('admin_toggle_quick', exam_id=exam.id) }}" style="display:inline;">
        <button type="submit" class="btn btn-sm btn-outline-{{ 'success' if exam.allow_quick_start else 'secondary' }}">
            {{ 'Disable Quick Start' if exam.allow_quick_start else 'Enable Quick Start' }}
        </button>
        </form>
    <form method="post" action="{{ url_for('admin_toggle_auto_start', exam_id=exam.id) }}" style="display:inline; margin-left:8px;">
        <button type="submit" class="btn btn-sm btn-outline-{{ 'success' if exam.auto_start_on_code else 'secondary' }}">
            {{ 'Disable Auto-Start' if exam.auto_start_on_code else 'Enable Auto-Start' }}
        </button>
        <a href="{{ url_for('admin_exam_codes', exam_id=exam.id) }}" class="btn btn-sm btn-secondary ms-2">Manage Codes</a>
        <a href="{{ url_for('admin_exam_codes_export', exam_id=exam.id) }}" class="btn btn-sm btn-outline-primary ms-2">Export Codes</a>
    </form>
    <p><strong>Description:</strong> {{ exam.description or '—' }}</p>

    <h3>Questions ({{ questions|length }})</h3>
    <ul>
    {% for q in questions %}
        <li>{{ loop.index }}. {{ q.question_text }} {% if q.marks %}(<em>{{ q.marks }} mark{% if q.marks>1 %}s{% endif %}</em>){% endif %}</li>
    {% else %}
        <li>No questions found for this subject.</li>
    {% endfor %}
    </ul>

        <hr />
        <h4>Exam Image</h4>
        {% if exam.exam_image %}
            <div>
                <div style="max-width:100%; display:flex; flex-direction:column; gap:6px;">
                    <img id="exam-image" src="{{ url_for('serve_uploads', filename=exam.exam_image) }}" alt="Exam image" style="max-width:100%; height:auto; max-height:400px; object-fit:contain; border:1px solid #ddd; padding:4px;" />
                    <div>
                        <label>Width: <input id="img-width" type="number" value="300" min="50" style="width:80px;"/> px</label>
                        <label style="margin-left:8px">Max Height: <input id="img-maxh" type="number" value="400" min="50" style="width:80px;"/> px</label>
                        <button id="img-reset" class="btn btn-sm btn-outline-secondary" type="button">Reset</button>
                    </div>
                </div>
                <div class="mt-2">
                    <a href="{{ url_for('admin_edit_exam', exam_id=exam.id) }}" class="btn btn-sm btn-outline-primary">Replace Image</a>
                </div>
            </div>
            <script>
            (function(){
                var img = document.getElementById('exam-image');
                var w = document.getElementById('img-width');
                var h = document.getElementById('img-maxh');
                var reset = document.getElementById('img-reset');
                function apply(){
                    var valW = parseInt(w.value)||300;
                    var valH = parseInt(h.value)||400;
                    img.style.width = valW ? (valW + 'px') : 'auto';
                    img.style.maxHeight = valH ? (valH + 'px') : 'none';
                }
                w.addEventListener('input', apply);
                h.addEventListener('input', apply);
                reset.addEventListener('click', function(){ w.value=300; h.value=400; apply(); });
                apply();
            })();
            </script>
        {% else %}
            <div class="text-muted">No exam image uploaded.</div>
            <div class="mt-2"><a href="{{ url_for('admin_edit_exam', exam_id=exam.id) }}" class="btn btn-sm btn-primary">Upload Image</a></div>
        {% endif %}

        <hr />
        <h4>Recorded Sessions</h4>
        {% if recordings %}
            <form method="post" action="{{ url_for('admin_delete_recordings', exam_id=exam.id) }}" onsubmit="return confirm('Delete selected recordings?');">
            <div class="mb-2">
                <button type="submit" class="btn btn-sm btn-danger">Delete Selected</button>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="select-all">Select All</button>
            </div>
            <ul>
                {% for r in recordings %}
                    <li class="mb-1">
                        <input type="checkbox" name="recording_id" value="{{ r.id }}" class="me-2 rec-check" />
                        Student: {{ r.student_full_name or r.student_username or 'Unknown' }}
                        | Class: {{ r.student_class or '—' }}
                        | Session: {{ r.session_id }}
                        | Uploaded: {{ r.uploaded_at.strftime('%Y-%m-%d %H:%M') if r.uploaded_at else '' }}
                        <a href="{{ url_for('serve_recording', filename=r.filename_basename) }}" class="ms-2">View</a>
                    </li>
                {% endfor %}
            </ul>
            </form>
            <script>
                document.getElementById('select-all').addEventListener('click', function(){
                    var checks = document.querySelectorAll('.rec-check');
                    var allChecked = Array.from(checks).every(c => c.checked);
                    checks.forEach(c => c.checked = !allChecked);
                });
            </script>
        {% else %}
            <div class="text-muted">No recordings found for this exam.</div>
        {% endif %}

        <a href="{{ url_for('admin_exams') }}" class="btn btn-secondary">Back to Exams</a>
</div>
</body>
</html>
