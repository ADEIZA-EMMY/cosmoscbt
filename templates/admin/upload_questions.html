{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">Upload Questions from Excel</h4>
            </div>
            <div class="card-body">
                {% if upload_errors %}
                <div class="alert alert-danger">
                    <h6 class="mb-2">Upload validation errors</h6>
                    <p>The upload was rejected. Fix the file and try again. Problematic rows:</p>
                    <ul>
                        {% for r, reason in upload_errors %}
                        <li>Excel row <strong>{{ r }}</strong>: {{ reason }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Excel File Format</h6>
                    <p>Your Excel file should have the following columns:</p>
                    <ul>
                        <li><strong>Question</strong> - The question text (required)</li>
                        <li><strong>Option A</strong> - First option (required)</li>
                        <li><strong>Option B</strong> - Second option (required)</li>
                        <li><strong>Option C</strong> - Third option (optional)</li>
                        <li><strong>Option D</strong> - Fourth option (optional)</li>
                        <li><strong>Option E</strong> - Fifth option (optional)</li>
                    <form method="POST" action="{{ url_for('upload_questions') }}" enctype="multipart/form-data">
                        <div class="note">
                            <strong>Tip:</strong> Download the official upload template and fill it before uploading.
                            <a href="/admin/question/template">Download template (Excel)</a>
                            <br>
                            Required columns: <em>Question, Option A, Option B, Correct Answer</em>
                        </div>

                        <li><strong>Explanation</strong> - Explanation for the answer (optional)</li>
                        <li><strong>Mark</strong> - Marks for the question (optional, default: 1)</li>
                    </ul>
                    <p class="mb-0">Download <a href="#" class="alert-link">sample template</a> for reference.</p>
                </div>

                <form method="POST" action="{{ url_for('upload_questions') }}" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="subject_id" class="form-label">Subject</label>
                            <select class="form-select" id="subject_id" name="subject_id" required>
                                <option value="">Select Subject</option>
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}" data-class="{{ subject.subject_class or '' }}">{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="subject_class" class="form-label">Class</label>
                            <select class="form-select" id="subject_class" name="subject_class">
                                <option value="">(no class)</option>
                                {% if classes %}
                                    {% for cls in classes %}
                                        <option value="{{ cls }}">{{ cls }}</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="file" class="form-label">Excel File</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".xlsx,.xls" required>
                            <div class="form-text">Only .xlsx and .xls files are allowed</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="images" class="form-label">Optional: Question Images</label>
                            <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple>
                            <div class="form-text">Upload images referenced by filename in the Excel "Image Filename" column.</div>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('admin_questions') }}" class="btn btn-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-success">Upload Questions</button>
                    </div>
                </form>
                <script>
                    // Auto-select subject_class when a subject is chosen
                    (function(){
                        const subjSelect = document.getElementById('subject_id');
                        const classSelect = document.getElementById('subject_class');
                        if(!subjSelect || !classSelect) return;
                        subjSelect.addEventListener('change', function(){
                            const opt = subjSelect.options[subjSelect.selectedIndex];
                            const cls = opt ? opt.getAttribute('data-class') : '';
                            if(!cls) return;
                            // try to find matching option in classSelect
                            for(let i=0;i<classSelect.options.length;i++){
                                if(classSelect.options[i].value === cls){
                                    classSelect.selectedIndex = i; return;
                                }
                            }
                            // if not found, add it as an option and select
                            const newOpt = document.createElement('option');
                            newOpt.value = cls; newOpt.text = cls; newOpt.selected = true;
                            classSelect.appendChild(newOpt);
                        });
                    })();
                </script>
            </div>
        </div>
    </div>
</div>
{% endblock %}